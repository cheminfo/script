clearLog();
var list = ['id=5603405&key=euHXpZ2xuj','id=5603878&key=KQDCBG0qY9','id=5603881&key=Xay6Wn02QU','id=5603884&key=TNVPKz3yjV','id=5603887&key=kJXNu94HTZ','id=5603890&key=XzxLaU3flV','id=5603802&key=Rjs8ASkIKe','id=5603841&key=YGycCKJxa8','id=5603838&key=lRBeCCG7X0','id=5603787&key=R1ivWn9Rs2','id=5603790&key=OSgVgmEuAy','id=5603793&key=ZrV2ugKQjV','id=5603796&key=jAjnoP4ep4','id=5603799&key=zmHMJfz8ZQ','id=5603805&key=IujbTVGTj0','id=5603808&key=YRC1NmMlQu','id=5603811&key=CW65R0jNVh','id=5603814&key=l5une08m2i','id=5603817&key=fAvt5QCiVN','id=5603820&key=ecAdZWCW7S','id=5603823&key=QZdftWHwed','id=5603826&key=v2gm25WcvA','id=5603829&key=28XySJH6eP','id=5603832&key=EE4KkEMvx1','id=5603893&key=6YmhsQAcpG','id=5603835&key=DN9ThSnzkv','id=5603868&key=opaV2owTDN','id=5603844&key=FvIN0lwyVv','id=5603874&key=TTIhbZDDzq','id=5603871&key=1WjQSzOcgm','id=5603865&key=j4x1E8zjic','id=5603862&key=sG9IQwYxGv','id=5603859&key=GGqxmYOVH8','id=5603856&key=GEKVOYZRat','id=5603847&key=Hnq6F8UhT9','id=5603850&key=O1JqqJDZ5d','id=5603853&key=1MA64YlSNx','id=5603654&key=Avo0hjbds3','id=5603651&key=2pnHV5nUZJ','id=5603657&key=pxDAn6BrHM','id=5603660&key=6L6WXkUF1n','id=5603663&key=DUxyKzDUyJ','id=5603666&key=TANZj2o72o','id=5603669&key=rJvzwydDeR','id=5603672&key=gZlmSI8yjd','id=5603675&key=BGV98PQMZO','id=5603678&key=JY9brxjbsS','id=5603681&key=hLjVNVlSBP','id=5603684&key=PhsO4i3vFa','id=5603687&key=4EKxDuss96','id=5603690&key=KbRFBbjgwP','id=5603648&key=PyfMk1Hkho','id=5603645&key=KXyxtwwGl9','id=5603642&key=qtKtA3xBzz','id=5603603&key=WmctD9ioyo','id=5603606&key=aF5NcqZguJ','id=5603612&key=VImKr79icf','id=5603609&key=i6Imdnt3I6','id=5603615&key=LIa5mhOJnQ','id=5603618&key=sima5frqsU','id=5603621&key=IAC0abqiKX','id=5603624&key=jKEAJuG6wf','id=5603627&key=SItyyH4Nj7','id=5603630&key=M9GBCqILp4','id=5603633&key=OEt0xZZFbA','id=5603636&key=AUxyTtqsoN','id=5603639&key=lnpfN4cdL4','id=5603600&key=GaJvIdowK3','id=5603705&key=HV5wY4ymAH','id=5603744&key=gcHL5BKUSp','id=5603748&key=6BDX8WY2Jx','id=5603754&key=vnCpQ6Vppn','id=5603757&key=k9i12ccWqA','id=5603760&key=wocAH7Zt51','id=5603763&key=qoIeeTgKSO','id=5603766&key=LiOXp7k7cA','id=5603769&key=IWeotLuG74','id=5603772&key=aCgDCXs2UR','id=5603775&key=AoC9iUuDux','id=5603778&key=aVKsH6YPZe','id=5603781&key=oVMDeidKfA','id=5603784&key=bbsSCL5E83','id=5603741&key=XQM6IrVwd1','id=5603738&key=rFvAekkUV7','id=5603735&key=C9AHRbb4IZ','id=5603693&key=bjgNI6hi2i','id=5603696&key=NiRoEdCgsO','id=5603699&key=YyJ5p9Qalr','id=5603702&key=W04mrGw9AC','id=5603751&key=59w6DfCDsq','id=5603708&key=MUfLhTx4HJ','id=5603711&key=1Udw6Cd3DV','id=5603714&key=CgNS2GfwfT','id=5603732&key=KiHZzfQ3NE','id=5603729&key=TWfezuBR7b','id=5603726&key=TjhMwmVFKP','id=5603723&key=GxrrOahA30','id=5603720&key=yA9V4fvhEE','id=5603717&key=eCwVy5dJpt','id=5603552&key=eh5ng46W56','id=5603549&key=ALopw4eGD3','id=5603546&key=HnVQUSjyjY','id=5603543&key=6VLGxOvfSw','id=5603540&key=qrywYfZonB','id=5603537&key=0wOAmSXQoi','id=5603534&key=SAl2rkShtQ','id=5603531&key=z0MFSgUwHk','id=5603528&key=R7UtQ07kEI','id=5603525&key=T7XGbt6uMX','id=5603522&key=N8zYYCWjjJ','id=5603519&key=nj65KfjpP6','id=5603555&key=3JP8u1G4mJ','id=5603558&key=2R2NPfMdCH','id=5603561&key=9dxhqnvymJ','id=5603594&key=xC8exNWb3r','id=5603591&key=2HSNp2IFVf','id=5603588&key=rXqWJ22S7T','id=5603585&key=ggNUKPrPIt','id=5603582&key=GVug7L1Lwl','id=5603579&key=lbDA6S6B6d','id=5603576&key=8652OSQMvI','id=5603573&key=PqaNXdIqPi','id=5603570&key=fjcLjm3sJA','id=5603567&key=oNXL5aaP5w','id=5603564&key=0pJKXWO8n1','id=5603597&key=FhSwTx2waS','id=5603516&key=KaR613SQe7','id=5603477&key=YWKua088vf','id=5603474&key=XgSaIbI0NU','id=5603471&key=2nDpiz2Bkz','id=5603468&key=Tv16D80wBp','id=5603465&key=XqwXg1C1Nc','id=5603462&key=SIzqbcIY5N','id=5603459&key=Z5ehWZZsGs','id=5603456&key=jD83Ur0HzU','id=5603453&key=kbE34PrnS1','id=5603480&key=joMSdnFSty','id=5603483&key=MC1vMF4IPq','id=5603486&key=OBXReyRBN3','id=5603513&key=ipZ7WnfTaP','id=5603510&key=5c8Irlwgz6','id=5603507&key=7A9eR7BieT','id=5603504&key=r81e2Fy8vn','id=5603501&key=55KmWrPZq8','id=5603498&key=07wOf9f5TL','id=5603495&key=rQiv2evDp7','id=5603492&key=FP8hdq5AdM','id=5603489&key=V3RE7j5tv7','id=5603417&key=yWtxbBqSUw','id=5603414&key=8ytCYL8Y11','id=5603411&key=HPU63nbNnV','id=5603408&key=iGWqG6Y6zf','id=5603402&key=uTyTxsSPhX','id=5603399&key=BqPud0nQEJ','id=5603423&key=koexhH0D7S','id=5603420&key=NXcGgsQ73P','id=5603426&key=j8h1HeEpIh','id=5603447&key=nr8bdSt838','id=5603444&key=FNczNuLLW2','id=5603441&key=Zwcs8OWZvB','id=5603438&key=3FNF5M5bx7','id=5603435&key=U4Ne3WtpIg','id=5603432&key=uBH6mjcUI0','id=5603429&key=E3n0w9FlGt','id=5603348&key=audP6OMhMT','id=5603345&key=kbP1CwOwIj','id=5603342&key=7K9v2rfpd7','id=5603339&key=WGzCoFnqcw','id=5603336&key=e5J3hqIj0m','id=5603333&key=NX3Zd5VuDF','id=5603330&key=1CWQinWFit','id=5603327&key=NzhhZHpg24','id=5603324&key=1oT1N9Wdph','id=5603321&key=Ju5BA6GB7a','id=5603318&key=TWthK0r0r9','id=5603315&key=V5g6Kepiev','id=5603312&key=ChkQyjXy8q','id=5603351&key=pza9XYAUpY','id=5603354&key=U4sC1XdcqL','id=5603357&key=CBaRtOuSFl','id=5603396&key=BOSuqJQW7O','id=5603393&key=4XwzGzndF6','id=5603390&key=CQpb91iPua','id=5603387&key=ASOyeHEsCU','id=5603384&key=R8VQlOd6Cb','id=5603381&key=LD2wBA8v2p','id=5603378&key=6wehVoCQtJ','id=5603375&key=ohDkQdQ6xj','id=5603372&key=bz6gvmC48S','id=5603369&key=aTMh5nR8ee','id=5603366&key=3GMuuy4cvC','id=5603363&key=sd4SINBcCg','id=5603360&key=hFJUtTmAgr','id=5603279&key=KLIJOxbJa4','id=5603276&key=DL8I1X3NoS','id=5603273&key=l3W5nOdRXy','id=5603270&key=mDwIwita4s','id=5603267&key=Ri9psRLhy2','id=5603264&key=lY7Zgs5jpk','id=5603261&key=kwfgKjdYwo','id=5603285&key=gSYW9xqjLl','id=5603288&key=Np6lzoZZpT','id=5603309&key=ZvCOXu31ZW','id=5603306&key=KRpjSTm0eo','id=5603303&key=GyyTM2vy6S','id=5603300&key=nVDgk1A4ta','id=5603297&key=Aa0GbVSxPA','id=5603294&key=M3hScGRRBp','id=5603291&key=d0jNfPF4SX','id=5603282&key=ByD5Ln8D9I','id=5603240&key=L5SJKFdjAw','id=5603243&key=NVbCaggral','id=5603246&key=NWhhCVj5TW','id=5603249&key=1DP1Y2ZqFK','id=5603252&key=pBSIFH3M77','id=5603255&key=9ylBqDWcAe','id=5603258&key=iHxF1EOQyA','id=5603207&key=xGPwwLQokb','id=5603204&key=PeRd2QQ6Jv','id=5603201&key=vKwCegfzcO','id=5603198&key=Nd9AgyBHwE','id=5603195&key=S7CrRZOiZk','id=5603231&key=OpCMEOtvNJ','id=5603192&key=q0uacLvvzm','id=5603189&key=Ay18ZvXvSO','id=5603210&key=YCqkhI0vbn','id=5603213&key=cE2N4OCNBt','id=5603237&key=RRC5gXBNGA','id=5603234&key=eq9WCAH9iQ','id=5603228&key=s5eZhuXSLZ','id=5603225&key=UmTkNVKMMg','id=5603222&key=3lzM4q6jk9','id=5603219&key=9DWDfWZFXU','id=5603216&key=eAfJ5P1aS0','id=5603186&key=4Ds2botlWV','id=5603168&key=xlRI1tiVXD','id=5603171&key=WAGKnEfEvZ','id=5603174&key=6w4TKkN5Bn','id=5603177&key=nuNi05ggGW','id=5603180&key=UWX0TYSMJA','id=5603183&key=N5ocj6M58U','id=5603147&key=I5InymjQK3','id=5603141&key=ebcIc7nICb','id=5603144&key=BGkKmMwjS5','id=5603159&key=Br74yawz4k','id=5603165&key=k4OcSat91s','id=5603162&key=gAoo4zZo6B','id=5603156&key=eDQtQTH44D','id=5603153&key=RgtiqEmsRL','id=5603150&key=274gEQMGIr'];

//path to the simulated spectra
var server='http://clo1v2.mylims.org';
var url=server+'/lims/Lims?action=GetJSON&table=entry&';

var spectrum;

var nMol=50;//list.length;//How many entries do you want to analyze
var nSpec=5;//How many spectra per entry do you want to take into account
var maxSize=nMol*nSpec;
var index=0;
var spectrum;

//var labels=new Array(maxSize);
var treeMap=new Array(maxSize);
var binMap=new Array(maxSize);
var molData=new Array(nMol);

//var treeComp = Distance.getComparator({'name':'Tree2Similarity','minWindow':4,'k':4250,'weight':0.57,'alpha':0.5});//1H-AO
var treeComp = Distance.getComparator({'name':'Tree2Similarity','minWindow':16,'k':4250,'weight':0.33,'alpha':0.5});//1H-HL
//var comp = Distance.getComparator({'name':'Tree2Similarity','minWindow':33,'k':3298,'weight':0.0.26,'alpha':0.38});//13C
var binComp = Distance.getComparator({'name':'BinningSimilarity','std':0.28});
var cosBinary = Distance.getComparator({'name':'CosineSimilarity'});

for(var mol=0;mol<nMol;mol++){
    var jsonEntry=eval('('+Default.getUrlContent(url+list[mol])+')');
	var entry=jsonEntry.entry[0];

	molData[mol]=Actelion.getMoleculeInfo(entry.mols[0].value).get('index');//cosBinary.getMap(molVector.index);
		
    var nspe=0, cont=0;
	while(nspe<nSpec){
      if(entry.nmrs[cont].nucleus=="1H"){
        var urli=server+entry.nmrs[cont].resourceURL;
        
        spectrum=SD.loadJcamp(urli).getEquallySpacedDataInt(0, 10, 1024);
      	treeMap[index]=treeComp.getMap(spectrum,1);
      	binMap[index]=binComp.getMap(spectrum,1);
        //Defining the label for the dendogram
       //labels[index]=entry.batchID+'_'+index+'\t'+entry.batchID+'\t'+urli;
        
      	nspe++;
        index++;
      }
      cont++;
    }
}

////////////////////////////////////////////////////////////////////////
///////////////////Start of similarity calculations/////////////////////
////////////////////////////////////////////////////////////////////////

//Creating the target matrix
var target = new Array(maxSize);
for (var i=0;i<maxSize;i++)
	target[i]=new Array(maxSize);

//Ones in the nSpec x nSpec block diagonal 
for(var mol=0;mol<nMol;mol++)
	for (var j=0;j<nSpec;j++)
		for (var k=0;k<nSpec;k++)
			target[mol*nSpec+j][mol*nSpec+k]=1;

//Creating the similarity matrices
var simTree = new Array(maxSize);
var simBin = new Array(maxSize);
for (var i=0;i<maxSize;i++) {
	simTree[i]=new Array(maxSize);
	simBin[i]=new Array(maxSize);
}

//Calculating similarities...
for (var i=0;i<maxSize;i++) {
	for (var j=i;j<maxSize;j++) {
	  //For trees
      simTree[i][j]=treeComp.quickSimilarity(treeMap[i],treeMap[j]);
      simTree[j][i]=simTree[i][j];
      //For bin
      simBin[i][j]=binComp.quickSimilarity(binMap[i],binMap[j]);
      simBin[j][i]=simBin[i][j];
	}
}

////////////////////////////////////////////////////////////////////////
////////////////End of similarity calculations//////////////////////////
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
//////////////////Start of the self analysis////////////////////////////
////////////////////////////////////////////////////////////////////////

var stats1 = Statistic.distribution(simTree,target);
var stats2 = Statistic.distribution(simBin,target);
//To create a google chart for the distributions
var sampTree = stats1.get('histogramSample');
var contTree = stats1.get('histogramControl');
var sampBin = stats2.get('histogramSample');
var contBin = stats2.get('histogramControl');

var lngChart = sampTree.length;
var data = new Array(lngChart+1);
data[0]=['similarity','Sample tree','Control tree', 'Sample bin', 'Control bin'];
for(var i =0;i<lngChart;i++)
	data[i+1]=[i,sampTree[i],contTree[i],sampBin[i],contBin[i]];

var googleChart0 = {'data':data,'options' :{title:'Sample and Control distribution'}};
jexport('googleChart0',googleChart0,'googleChart');


var roc = Statistic.ROCAnalysis(simTree, target,100);
//To create a google chart for the ROC curve
var rocX = roc.get('ROCx');
var rocY = roc.get('ROCy');
lngChart = rocX.length;
data = new Array(lngChart+1);
data[0]=['FPR','TPR'];
for(var i =0;i<lngChart;i++)
	data[i+1]=[rocX[i],rocY[i]];

var googleChart11 = {'data':data, 'options' :{title:'ROC curve for tree',vAxis: {title: "FPR"},hAxis: {title: "TPR"}}};
jexport('googleChart11',googleChart11,'googleChart');

roc = Statistic.ROCAnalysis(simBin, target,100);
//To create a google chart for the ROC curve
var rocX = roc.get('ROCx');
var rocY = roc.get('ROCy');
lngChart = rocX.length;
data = new Array(lngChart+1);
data[0]=['FPR','TPR'];
for(var i =0;i<lngChart;i++)
	data[i+1]=[rocX[i],rocY[i]];

var googleChart12 = {'data':data, 'options' :{title:'ROC curve for bin',vAxis: {title: "FPR"},hAxis: {title: "TPR"}}};
jexport('googleChart12',googleChart12,'googleChart');


jexport('treeStatistics',stats1);
jexport('binStatistics',stats2);

////////////////////////////////////////////////////////////////////////
///////////////////End of the self analysis/////////////////////////////
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
///////////////////Start of hitList analysis////////////////////////////
////////////////////////////////////////////////////////////////////////

var molSim = new Array(nMol);
var treeSimExp = new Array(nMol);
var binSimExp = new Array(nMol);
for (var i=0;i<nMol;i++) {
	treeSimExp[i]=new Array(nMol);
	binSimExp[i]=new Array(nMol);
	molSim[i]=new Array(nMol);
}

//Calculating similarities for molecules
for (var i=0;i<nMol;i++) {
	for (var j=i;j<nMol;j++) {
		molSim[i][j]=cosBinary.quickSimilarity(molData[i],molData[j]);
		molSim[j][i]=molSim[i][j];
	}
}


var nHits = 50;
var hitListTree=null;
var hitListBin=null;
//For hit-list report we average the hit-list for every single experiment...
for(var k=0;k<nSpec;k++){
	for (var i=0;i<nMol;i++) {
		for (var j=i;j<nMol;j++) {
			treeSimExp[i][j]=simTree[i*nSpec+k][j*nSpec+k];
			treeSimExp[j][i]=treeSimExp[i][j];
			
			binSimExp[i][j]=simBin[i*nSpec+k][j*nSpec+k];
			binSimExp[j][i]=binSimExp[i][j];
		}
	}
	
	//For trees
	var hitListK1 = Statistic.hitList(treeSimExp, molSim,nHits);
	if(hitListTree==null)
		hitListTree=hitListK1;
	else{
		for(var i=0;i<nHits;i++)
			hitListTree[i]+=hitListK1[i];
	}
	
	//For bin
	var hitListK2 = Statistic.hitList(binSimExp, molSim,nHits);
	if(hitListBin==null)
		hitListBin=hitListK2;
	else{
		for(var i=0;i<nHits;i++)
			hitListBin[i]+=hitListK2[i];
	}
}

for(var i=0;i<nHits;i++){
	hitListBin[i]/=nSpec;
	hitListTree[i]/=nSpec;
}

//To create a google chart for the hitList curve
lngChart = hitListBin.length;
data = new Array(lngChart+1);
data[0]=['n','Avr. Similarity for trees', 'Avr. Similarity for Bin'];
for(var i =0;i<lngChart;i++){
	data[i+1]=[i+1,hitListTree[i],hitListBin[i]];
}
var googleChart1 = {'data':data, 'options' :{title:'Hit-List',vAxis: {title: "Avg. Similarity"},hAxis: {title: "n-hits"}}};
jexport('googleChart2',googleChart1,'googleChart');

////////////////////////////////////////////////////////////////////////
////////////////////End of hitList analysis/////////////////////////////
////////////////////////////////////////////////////////////////////////

//Create the dendrogram	
//var dendrogram = Distance.clustering(simTree,labels);
//Return to the client the JSON of the dendrogram
//jexport('dendrogram',dendrogram,'dendrogram'); 